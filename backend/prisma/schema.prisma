// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  fullName      String    @map("full_name")
  phone         String    @unique
  passwordHash  String?   @map("password_hash")
  createdAt     DateTime  @default(now()) @map("created_at")

  plans         Plan[]
  aiRequests    AiRequest[]
  favorites     Favorite[]
  applications  Application[]

  @@map("users")
}

model Plan {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  fileUrl      String    @map("file_url")
  analysisJson Json?     @map("analysis_json")
  createdAt    DateTime  @default(now()) @map("created_at")

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiRequests   AiRequest[]

  @@map("plans")
}

model AiRequest {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  planId          String    @map("plan_id")
  inputText       String?   @map("input_text")
  inputAudioUrl   String?   @map("input_audio_url")
  inputImageUrl   String?   @map("input_image_url")
  createdAt       DateTime  @default(now()) @map("created_at")

  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            Plan       @relation(fields: [planId], references: [id], onDelete: Cascade)
  variants        Variant[]

  @@map("ai_requests")
}

model Variant {
  id                    String    @id @default(uuid())
  aiRequestId           String    @map("ai_request_id")
  thumbnailUrl          String?   @map("thumbnail_url")
  model3dUrl            String?   @map("model_3d_url")
  description           String
  normativeExplanation  String    @map("normative_explanation")
  approvalProbability   Float     @map("approval_probability")
  planGeometry          Json?     @map("plan_geometry")
  createdAt             DateTime  @default(now()) @map("created_at")

  aiRequest             AiRequest   @relation(fields: [aiRequestId], references: [id], onDelete: Cascade)
  favorites             Favorite[]
  applications          Application[]

  @@map("variants")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  variantId String   @map("variant_id")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant   Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([userId, variantId])
  @@map("favorites")
}

model Application {
  id           String              @id @default(uuid())
  userId       String              @map("user_id")
  variantId    String              @map("variant_id")
  address      String
  passportData String              @map("passport_data") // encrypted
  status       ApplicationStatus   @default(NEW)
  createdAt    DateTime            @default(now()) @map("created_at")

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant      Variant             @relation(fields: [variantId], references: [id], onDelete: Cascade)
  feedback     EngineerFeedback[]

  @@map("applications")
}

enum ApplicationStatus {
  NEW
  APPROVED
  REJECTED
  NEEDS_FIX
}

model AdminUser {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  feedback     EngineerFeedback[]

  @@map("admin_users")
}

model EngineerFeedback {
  id            String    @id @default(uuid())
  applicationId String    @map("application_id")
  adminId       String    @map("admin_id")
  comment       String?
  aiMistakeType String?   @map("ai_mistake_type")
  createdAt     DateTime  @default(now()) @map("created_at")

  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  admin         AdminUser   @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("engineer_feedback")
}


